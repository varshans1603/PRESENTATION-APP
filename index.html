<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Presenter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    :root { 
        --bg: #0a192f; 
        --card: #112240; 
        --glass: rgba(255,255,255,0.08); 
        --accent: #00d4ff; 
        --text: #e0f7fa; 
        --shadow: 0 12px 32px rgba(0,212,255,0.15); 
        --border: 1px solid rgba(0,212,255,0.25); 
        --hover: rgba(0,212,255,0.15);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
        background: linear-gradient(135deg, #0a192f 0%, #16213e 100%); 
        color: var(--text); 
        font-family: 'Inter', 'Segoe UI', sans-serif; 
        min-height: 100vh; 
        padding: 1.5rem; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        line-height: 1.6;
    }
    h1 { 
        font-size: 2.4rem; 
        margin: 1rem 0; 
        color: var(--accent); 
        text-shadow: 0 0 20px rgba(0,212,255,0.4); 
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    /* UPLOAD ZONE */
    #upload-zone { 
        width: 90vw; max-width:500px; height:130px; 
        border:2px dashed var(--accent); border-radius:18px; 
        display:flex; flex-direction:column; align-items:center; justify-content:center; 
        cursor:pointer; margin:1.2rem 0; background:var(--glass); 
        backdrop-filter:blur(12px); box-shadow:var(--shadow); 
        transition: all 0.3s ease;
    }
    #upload-zone:hover { 
        background:var(--hover); border-color:var(--accent); 
        transform:translateY(-3px); box-shadow: 0 16px 40px rgba(0,212,255,0.2);
    }
    #upload-zone.dragover { background:rgba(0,212,255,0.25); border-style:solid; }
    #upload { display:none; }
    #upload-label { font-weight:600; font-size:1.15rem; color:var(--accent); }

    /* CONTROLS */
    .controls { 
        display:flex; flex-wrap:wrap; gap:14px; justify-content:center; 
        margin:1.6rem 0; max-width:900px; 
    }
    button { 
        padding:13px 24px; background:var(--glass); color:var(--text); 
        border:var(--border); border-radius:14px; font-weight:600; 
        cursor:pointer; min-width:110px; font-size:0.98rem; 
        backdrop-filter:blur(12px); transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    button:hover { 
        background:var(--hover); transform:translateY(-3px); 
        box-shadow: 0 8px 20px rgba(0,212,255,0.25); 
    }
    button.active { 
        background: linear-gradient(135deg, #ff00ff, #ff3399); 
        color:white; border:none; 
        box-shadow:0 0 25px rgba(255,0,255,0.7); 
        transform:scale(1.05);
    }

    /* STATUS */
    #status { 
        font-weight:600; font-size:1.15rem; text-align:center; 
        padding:14px; background:var(--glass); border-radius:14px; 
        max-width:900px; margin:0.6rem 0; color:var(--accent); 
        box-shadow:var(--shadow); border:var(--border); 
        backdrop-filter:blur(12px); 
    }

    /* CONTAINER */
    #container { 
        position:relative; width:90vw; max-width:1100px; height:68vh; 
        border:2px solid var(--accent); border-radius:20px; 
        overflow:hidden; background:white; margin:1.2rem 0; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.3), var(--shadow); 
    }
    canvas { position:absolute; top:0; left:0; width:100%; height:100%; }

    /* VIDEO */
    #video-container { 
        position:fixed; bottom:22px; right:22px; width:240px; height:180px; 
        border:3px solid var(--accent); border-radius:18px; 
        overflow:hidden; box-shadow: 0 12px 30px rgba(0,0,0,0.4); 
        z-index:999; background:#000; 
    }
    #video { width:100%; height:100%; transform:scaleX(-1); object-fit:cover; border-radius:14px; }

    /* LASER */
    #laser-pointer { 
        position:absolute; width:22px; height:22px; background:#ff3333; 
        border:4px solid #ff6666; border-radius:50%; pointer-events:none; 
        display:none; transform:translate(-50%,-50%); 
        box-shadow:0 0 25px 10px rgba(255,51,51,0.9); z-index:20; 
    }

    /* VOICE STATUS */
    #voice-status { 
        position:fixed; top:20px; left:20px; 
        background:rgba(0,255,0,0.25); color:#0f0; 
        padding:12px 18px; border-radius:10px; font-weight:600; 
        z-index:1000; border:1px solid #0f0; display:none; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* DEBUG */
    #debug-container { max-width:900px; margin:1.8rem 0; width:90vw; }
    #debug-header { 
        background:var(--glass); padding:14px; border-radius:14px 14px 0 0; 
        cursor:pointer; display:flex; justify-content:space-between; 
        font-weight:600; color:var(--accent); backdrop-filter:blur(12px); 
        border:var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #debug { 
        background:#000; color:#0f0; font-family:'Courier New',monospace; 
        font-size:0.88rem; max-height:160px; overflow-y:auto; 
        padding:14px; border-radius:0 0 14px 14px; display:none; 
        border:var(--border); border-top:none; 
    }
    #debug.show { display:block; }

    /* HELP MODAL (F1) */
    #help-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10,25,47,0.95); backdrop-filter: blur(12px);
        display: none; align-items: center; justify-content: center;
        z-index: 10000; padding: 1rem;
    }
    #help-content {
        background: var(--card); border: var(--border); border-radius: 20px;
        padding: 2rem; max-width: 800px; width: 100%; max-height: 85vh;
        overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        color: var(--text);
    }
    #help-close {
        position: absolute; top: 1rem; right: 1.5rem;
        background: none; border: none; color: var(--accent);
        font-size: 2rem; cursor: pointer; font-weight: bold;
    }
    .help-section {
        margin-bottom: 1.8rem;
    }
    .help-section h3 {
        color: var(--accent); margin-bottom: 0.8rem; font-size: 1.3rem;
        font-weight: 600; border-bottom: 1px solid rgba(0,212,255,0.3);
        padding-bottom: 0.5rem;
    }
    .help-section ul {
        margin-left: 1.2rem; margin-top: 0.8rem;
    }
    .help-section li {
        margin: 0.6rem 0; position: relative; padding-left: 1.2rem;
    }
    .help-section li::before {
        content: "→"; color: var(--accent); position: absolute; left: 0;
    }
    .help-section code {
        background: rgba(0,212,255,0.15); color: #0ff; padding: 0.2rem 0.5rem;
        border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9rem;
    }
    .help-tip {
        background: rgba(0,212,255,0.1); padding: 1rem; border-radius: 12px;
        border-left: 4px solid var(--accent); font-style: italic; margin-top: 1.2rem;
        color: #b8f3ff;
    }

    @media (max-width:768px) { 
        #container { height:58vh; } 
        #video-container { width:170px; height:128px; bottom:16px; right:16px; }
        h1 { font-size: 2rem; }
    }
</style>
</head>
<body>

<h1>Smart Presenter</h1>

<!-- F1 HELP MODAL -->
<div id="help-modal">
    <div id="help-content">
        <button id="help-close">×</button>
        <h2 style="color:var(--accent); margin-bottom:1rem; text-align:center;">How to Use Smart Presenter</h2>
        
        <div class="help-section">
            <h3>Mouse Mode (Default)</h3>
            <ul>
                <li><strong>Draw</strong>: Click + drag → red line</li>
                <li><strong>Highlight</strong>: Click + drag → yellow glow</li>
                <li><strong>Erase</strong>: Click + drag → erase annotations</li>
                <li><strong>Laser</strong>: Click → red dot follows cursor</li>
                <li><strong>Stop</strong>: Stops drawing/laser</li>
                <li><strong>Prev / Next</strong>: Navigate slides</li>
                <li><strong>Clear All</strong>: Remove all annotations</li>
                <li><strong>Save PDF</strong>: Download with annotations</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>Gesture Mode (Hand Tracking)</h3>
            <p><strong>Allow camera</strong> → show hand in video feed</p>
            <ul>
                <li><strong>Index Finger Up</strong>: <strong>Draw</strong> (red line)</li>
                <li><strong>Pinch (Thumb + Index)</strong>: <strong>Highlight</strong> (yellow)</li>
                <li><strong>Fist</strong>: <strong>Erase</strong></li>
                <li><strong>Two Fingers Up</strong>: <strong>Laser</strong> (red dot)</li>
                <li><strong>Open Hand</strong>: <strong>Open Palm</strong> Stop all</li>
                <li><strong>Swipe Right</strong>: Next page</li>
                <li><strong>Swipe Left</strong>: Prev page</li>
            </ul>
            <p><em>Hold gesture for 0.5s to activate</em></p>
        </div>

        <div class="help-section">
            <h3>Voice Mode (Speak Commands)</h3>
            <p><strong>Allow mic</strong> → say commands clearly</p>
            <ul>
                <li><code>draw hello world</code> → writes paragraph</li>
                <li><code>stop</code> / <code>done</code> → stops writing</li>
                <li><code>next</code> → next page</li>
                <li><code>previous</code> / <code>back</code> → prev page</li>
                <li><code>page 5</code> → jump to page 5</li>
                <li><code>last page</code> → last page</li>
                <li><code>clear</code> → clear annotations</li>
                <li><code>mouse</code> → switch to mouse</li>
                <li><code>gesture</code> → switch to hand</li>
            </ul>
        </div>

        <div class="help-tip">
            <strong>Pro Tip:</strong> Press <kbd>F1</kbd> anytime for help • Use <strong>Save PDF</strong> to export your annotated presentation!
        </div>
    </div>
</div>

<div id="upload-zone">
    <input type="file" id="upload" accept=".pdf">
    <label id="upload-label" for="upload">Drop PDF or Click to Upload</label>
</div>

<div class="controls">
    <button data-mode="mouse" class="active">Mouse</button>
    <button data-mode="gesture">Gesture</button>
    <button data-mode="voice">Voice</button>
</div>

<div class="controls" id="mouse-tools">
    <button data-tool="draw" class="active">Draw</button>
    <button data-tool="highlight">Highlight</button>
    <button data-tool="erase">Erase</button>
    <button data-tool="laser">Laser</button>
    <button data-tool="none">Stop</button>
</div>

<div class="controls">
    <button id="prev">Prev</button>
    <button id="next">Next</button>
    <button id="clear">Clear All</button>
    <button id="save-pdf">Save PDF</button>
</div>

<div id="status">Ready • Press F1 for Help</div>

<div id="container">
    <canvas id="pdf-canvas"></canvas>
    <canvas id="annotation-canvas"></canvas>
    <div id="laser-pointer"></div>
</div>

<div id="video-container"><video id="video" autoplay playsinline muted></video></div>
<div id="voice-status">Listening...</div>

<div id="debug-container">
    <div id="debug-header" onclick="this.nextElementSibling.classList.toggle('show')">Debug Console</div>
    <div id="debug"></div>
</div>

<!-- HELPERS -->
<script>
window.$ = s => document.querySelector(s);
window.$$ = s => [...document.querySelectorAll(s)];

window.debug = (msg) => {
    const d = $('#debug');
    if (!d) return;
    const t = new Date().toLocaleTimeString();
    d.innerHTML += `<div>[${t}] ${msg}</div>`;
    d.scrollTop = d.scrollHeight;
};

window.toast = (msg, dur = 2200) => {
    if (!document.body) return;
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
        background:rgba(0,212,255,0.25); color:#0ff; padding:14px 28px; border-radius:14px;
        font-weight:600; z-index:1000; backdrop-filter:blur(12px); border:1px solid #0ff;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), dur);
};

window.speak = (txt) => {
    const u = new SpeechSynthesisUtterance(txt);
    u.rate = 1.5;
    speechSynthesis.speak(u);
};

// F1 OPENS HELP
document.addEventListener('keydown', e => {
    if (e.key === 'F1') {
        e.preventDefault();
        $('#help-modal').style.display = 'flex';
    }
});
$('#help-close').onclick = () => $('#help-modal').style.display = 'none';
$('#help-modal').onclick = e => {
    if (e.target === $('#help-modal')) $('#help-modal').style.display = 'none';
};
</script>

<!-- PDF.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';
</script>

<!-- DRAG & DROP -->
<script>
$('#upload-zone').addEventListener('click', () => $('#upload').click());
$('#upload-zone').addEventListener('dragover', e => { e.preventDefault(); $('#upload-zone').classList.add('dragover'); });
$('#upload-zone').addEventListener('dragleave', () => $('#upload-zone').classList.remove('dragover'));
$('#upload-zone').addEventListener('drop', e => {
    e.preventDefault(); $('#upload-zone').classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') {
        $('#upload').files = e.dataTransfer.files;
        $('#upload').dispatchEvent(new Event('change'));
    }
});
</script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<!-- MAIN APP -->
<script type="module" src="./main.js"></script>
<script src="./gesture.js"></script>
<script src="./voice.js"></script>

<!-- SAVE PDF -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
$('#save-pdf').onclick = async () => {
    if (!window.app?.pdfDoc) { toast('No PDF loaded'); return; }
    toast('Saving PDF...');

    const pdfDoc = await PDFLib.PDFDocument.create();
    const pages = await Promise.all(
        Array.from({ length: window.app.pdfDoc.numPages }, (_, i) =>
            window.app.pdfDoc.getPage(i + 1)
        )
    );

    for (let i = 0; i < pages.length; i++) {
        const page = pages[i];
        const { width, height } = page.getViewport({ scale: 1 });
        const pdfPage = pdfDoc.addPage([width, height]);

        // Render page
        const canvas = document.createElement('canvas');
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport: page.getViewport({ scale: 1 }) }).promise;
        const imgData = canvas.toDataURL('image/png');
        const img = await pdfDoc.embedPng(await fetch(imgData).then(r => r.arrayBuffer()));
        pdfPage.drawImage(img, { x: 0, y: 0, width, height });

        // Add annotations
        const annData = window.app.annCanvas.toDataURL('image/png');
        const annImg = await pdfDoc.embedPng(await fetch(annData).then(r => r.arrayBuffer()));
        pdfPage.drawImage(annImg, { x: 0, y: 0, width: window.app.annCanvas.width, height: window.app.annCanvas.height });
    }

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'annotated_presentation.pdf'; a.click();
    toast('PDF Saved Successfully!');
};
</script>

</body>
</html>